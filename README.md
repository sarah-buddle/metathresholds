# metathresholds

This package is designed to apply filters to the raw outputs of metagenomics classifiers like Kraken2. This is because such classifiers sometimes return very large lists of species, some of which are not truly present in your sample. This package allows you to quickly compare to the negative control and calculate which species are likely to be present based on the thresholds you input.

## Installation instructions

## Input requirements

Samplesheet (required): Path to csv samplsheet file formatted according to the provided template. The sample links your sample IDs with their corresponding negative controls and the filepaths of your outputs from your taxonomic classifiers, as well as raw read counts for calculating thresholds. Leave the column names exactly as they are in the template, and just leave cells blank where you don't have outputs for that classifier.

sample_id:  You should list the sample IDs of all your samples, including negative controls, in this column. 

corresponding_control: Contains the sample_id of the corresponding negative control for each sample. For the negative controls, write control in this column.

dnarna: Either DNA, RNA or DNARNA, as appropriate for your sample

dnarna_pair: If you want to combine separate DNA and RNA seq results for the same sample, give each DNA-RNA pair a unique name in this column

raw_read_1: Number of raw reads (R1 only for paired-end reads)

raw_read_2: Number of raw reads (R2 only for paired-end reads, leave blank for single-end reads)

xx_filepath: Full global filepath to the output file of the relevant taxonomic classifier. For Kraken2-based classifiers and metaMix, this is the report, not the read-level file. For CZID, the csv report should be downloaded individually for each sample. For OneCodex, it expects that the report will contain results for more than one sample, and looks for the sample_id given in the Sample Name field of the OneCodex output.

Taxonomizr db file (optional): Path to nameNode.sqlite file generated by taxonomizr::prepareDatabase. metathresholds depends on the taxonomizr package by Scott Sherrill-Mix (https://cran.rproject.org/web/packages/taxonomizr/index.html). If you haven't provided this database file, the package will generate one automatically, but this only has to be done once, and you can provide the filepath to speed up subsequent runs.

Metathresholds db file (optional): Path to csv file where metathresholds can store its databse. metathresholds creates its own database of all of the taxons in your analysis and whether they are a bacteria, virus, funus etc and if they are a subspecies, which species they belong to. Again, if you haven't provided this database file, the package will generate one automatically, but you can provide the filepath to speed up subsequent runs.

Thresholds file (optional): Path to csv file thresholds file formatted according to the provided template. These are the thresholds that will be applied to your data. You can also provide these as arguments to the makeFullReport function rather than providing this file. You can set different thresholds for bacteria, viruses, fungi and other eukaryotes. Taxa have to pass all thresholds to be called as positive.

reads: raw read threshold e.g. a reads_bacteria = 3 means reject any bacteria with fewer than 3 reads assigned

rpm: reads per million ratio = reads per million in sample / reads per million in negative control (a useful way to compare with the negative control).

proportion: proportion of reads. Depending on the option you choose, this can be proportion of reads that are classified and non-human (default) or the proportion of total raw reads in the sample

low_level: If true, only apply reads per million ratio threshold where there is at least one read corresponding to the taxon in the negative control. Where there are no reads corresponding to a particular taxon in the negative control, you can't calculate a reads per million ratio because you'd be dividing by 0. In this case, the reads per million ratio is calculated as if there was just one read in the control, which means the rpmr = number of raw reads in sample. This means that by default, if you have a virus_rpm of 5, you would automatically reject any viruses with fewer than 5 reads. To avoid this and still accept say a virus with 4 reads if there are no reads in the control (but reject if there are any reads in the control and this brings it under the rpm ratio you define), set this as true.

Positive species list (optional): Path to csv containing the taxon ids you expect to find (one on each line). If you know what species you are expected to be in your samples, you can provide a list of the corresponding taxon IDs and this allows metathresholds to calculate the sensitivity/specificity etc.

## Running
The main function is makeFullReport, which will import all your files from the filepaths on your samplesheet and call them as positive or negative according to your thresholds. A typical command might look like:
```
report <- makeFullReport(samplesheet_filepath = "samplesheet.csv",
                           taxonomizr_sql = "nameNode.sqlite",
                           db_filepath = "metathresholds_db.csv",
                           thresholds_filepath = "thresholds.csv")
```
If you've run separate DNA and RNA Seq on the same sample, you might want to combine the results and keep whichever gives the higher result. To do this, run:
```
combined_report <- combineDNARNA(report)
```
If you've run makeFullReport and provided a positive species list, you can count the total number of true and false positive and negative species and calculate sensitivity and specificity.
```
report_stats <- countSpecies(combined_report)
```
